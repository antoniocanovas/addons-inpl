<?xml version="1.0" encoding="utf-8" ?>
<odoo>

    <record id="mig_tarifas_cliente_as" model="ir.actions.server">
        <field name="name">=> 1. Crear tarifas por cadena</field>
        <field name="model_id" ref="custom_inplast.model_mig_lineastarifa"/>
        <field name="binding_model_id" ref="custom_inplast.model_mig_lineastarifa"/>
        <field name="evaluation_type">value</field>
        <field name="state">code</field>
        <field name="code">
# Importar tarifa para los clientes y direcciones de entrega que la tienen:
partners = []
for li in records:

    # Cliente con referencia de la línea (si tiene delegaciones sólo encuentra la empresa principal):
    partnerfactura = env['res.partner'].search([('ref','=',li.clientecod)])
    if not partnerfactura.id: raise UserError("No encuentro " + str(li.clientecod))

    # Aquí busca la dirección de entrega de la empresa anterior:
    partner = env['res.partner'].search([('name','=',li.name),('parent_id','=',partnerfactura.id)])
    if not partner.id: partner = partnerfactura

    refpricelist = str(li.clientecod) + "." + str(li.name)
    pricelist = env['product.pricelist'].search([('mig_codigocliente','=',refpricelist)])
    if (partner.id) and (partner.id not in partners):
        if not pricelist.id:
            impuestoalplastico = True
            if partner.country_id.code != 'ES': impuestoalplastico = False
            if partner.country_id.code == 'ES' and partner.state_id.code in ['TF','GC']: impuestoalplastico = False
            pricelist = env['product.pricelist'].create({
                'name': partner.name,
                'mig_codigocliente': refpricelist,
                'pnt_next_update': li.fechavalideztarifa,
                'pnt_last_update': li.fechaactualizacion,
                'pnt_lock_date': li.fechalimitepedido,
                'pnt_ethylene_price': li.precioetileno,
                'pnt_plastic_tax': impuestoalplastico,
            })

    partners.append(partner.id)

    li['pricelist_id'] = pricelist.id

    if (partner.property_product_pricelist.mig_codigocliente != li.clientecod):
        partner.write({'property_product_pricelist': pricelist.id})
        </field>
    </record>

</odoo>
